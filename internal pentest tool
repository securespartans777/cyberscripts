#!/bin/bash

# Define target ranges
TARGETS=(
  "60.0.0.0/29"
  "10.0.0.0/24"
  "10.0.0.0/24"
  "10.0.0.0/24"
  "10.0.0.0/24"
  "10.0.0.254/24"
  "172.162.0.100-200"
)

# Timestamp
SCAN_DATE=$(date +%Y%m%d_%H%M%S)
REPORT_DIR="scan_results_$SCAN_DATE"
mkdir -p "$REPORT_DIR"

# Check dependencies
for tool in nmap whatweb nikto gobuster; do
  if ! command -v $tool &>/dev/null; then
    echo "[!] $tool not found. Installing..."
    sudo apt-get install -y $tool || sudo snap install $tool || go install github.com/OJ/gobuster/v3@latest
    export PATH=$PATH:$(go env GOPATH)/bin
  fi
  command -v $tool &>/dev/null || { echo "[!] $tool still not found. Exiting."; exit 1; }
done

# Function to scan a single host
scan_host() {
  local IP=$1
  local HOST_DIR="$REPORT_DIR/$IP"
  mkdir -p "$HOST_DIR"
  echo "[+] Processing Host: $IP"

  # Nmap Full Vuln Scan
  echo "[*] Running Nmap Vuln Scan on $IP"
  nmap -A -T4 --script vuln,auth,default,ftp-anon,http-enum,http-vuln*,ssl-heartbleed,smb-enum-shares,smb-enum-users,smb-vuln* -p- $IP -oN "$HOST_DIR/nmap.txt" --script-args=unsafe=1

  # WhatWeb
  echo "[*] Running WhatWeb on $IP"
  whatweb http://$IP > "$HOST_DIR/whatweb.txt" 2>&1

  # Nikto
  echo "[*] Running Nikto on $IP"
  nikto -h http://$IP > "$HOST_DIR/nikto.txt" 2>&1

  # Gobuster
  echo "[*] Running Gobuster on $IP"
  gobuster dir -u http://$IP -w /usr/share/wordlists/dirb/common.txt -o "$HOST_DIR/gobuster.txt" 2>/dev/null || echo "Gobuster failed" > "$HOST_DIR/gobuster.txt"

  # Attempt to extract credentials, shells, users, etc.
  grep -Ei 'password|user|login|admin|shell|root|key|token' "$HOST_DIR"/* > "$HOST_DIR/sensitive_info.txt" || echo "No sensitive info found" > "$HOST_DIR/sensitive_info.txt"

  echo "[+] Completed: $IP"
}

# Iterate over each range and scan hosts
for RANGE in "${TARGETS[@]}"; do
  echo "[+] Scanning Range: $RANGE"
  nmap -sn "$RANGE" -oG - | awk '/Up$/{print $2}' | while read -r HOST; do
    scan_host "$HOST"
  done
  echo "[+] Completed Range: $RANGE"
done

# Generate HTML Report
REPORT_HTML="$REPORT_DIR/final_report.html"
echo "<html><head><title>Pentest Report</title></head><body><h1>Internal Pentest Report - $SCAN_DATE</h1>" > "$REPORT_HTML"
echo "<table border=1><tr><th>IP</th><th>Vulnerabilities</th><th>Exposures</th><th>Identities</th><th>Sensitive Info</th><th>Severity</th><th>Impact</th><th>Recommendation</th></tr>" >> "$REPORT_HTML"

for IP_DIR in "$REPORT_DIR"/*; do
  IP=$(basename "$IP_DIR")
  if [[ -f "$IP_DIR/nmap.txt" ]]; then
    VULNS=$(grep -Ei 'VULNERABLE|CVE|DoS|unauthorized|exposed' "$IP_DIR/nmap.txt" | sed 's/</\</g')
    SENSITIVE=$(cat "$IP_DIR/sensitive_info.txt" | sed 's/</\</g')
    echo "<tr><td>$IP</td><td><pre>$VULNS</pre></td><td>--</td><td>--</td><td><pre>$SENSITIVE</pre></td><td>Auto</td><td>Auto</td><td>Auto</td></tr>" >> "$REPORT_HTML"
  fi
done

echo "</table></body></html>" >> "$REPORT_HTML"

# Open Report
echo "[+] Report Generated: $REPORT_HTML"
echo "[+] You can open it in your browser."

# Done
exit 0
